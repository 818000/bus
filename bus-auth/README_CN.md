# ğŸ” Bus Authï¼šä¼ä¸šçº§èº«ä»½éªŒè¯ä¸æˆæƒæ¡†æ¶

<p align="center">
<strong>ç»Ÿä¸€èº«ä»½éªŒè¯å’Œæˆæƒè§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå¤šç§åè®®å’Œèº«ä»½æä¾›ç¨‹åº</strong>
</p>

-----

## ğŸ“– é¡¹ç›®ç®€ä»‹

**Bus Auth** æ˜¯ä¸€ä¸ªä¼ä¸šçº§èº«ä»½éªŒè¯å’Œæˆæƒæ¡†æ¶ï¼Œæ—¨åœ¨ç®€åŒ–ä¸ç¬¬ä¸‰æ–¹èº«ä»½æä¾›ç¨‹åºçš„é›†æˆã€‚å®ƒæä¾›ç»Ÿä¸€çš„ API æ¥å®ç° OAuth2ã€SAMLã€LDAP å’Œè‡ªå®šä¹‰èº«ä»½éªŒè¯åè®®ï¼Œæ”¯æŒå…¨çƒ **40+** ä¸»æµå¹³å°ã€‚

è¯¥æ¡†æ¶æŠ½è±¡äº†åè®®å¤æ‚æ€§ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€Œéèº«ä»½éªŒè¯å®ç°ç»†èŠ‚ã€‚æ— è®ºæ˜¯ç¤¾äº¤ç™»å½•ã€ä¼ä¸š SSO è¿˜æ˜¯è‡ªå®šä¹‰èº«ä»½æä¾›ç¨‹åºï¼ŒBus Auth éƒ½æä¾›ä¸€è‡´ã€ç±»å‹å®‰å…¨å’Œå¯æ‰©å±•çš„æ–¹æ³•ã€‚

-----

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### ğŸ¯ ç»Ÿä¸€èº«ä»½éªŒè¯æ¥å£

* **åè®®æ— å…³**ï¼šOAuth2ã€SAMLã€LDAP å’Œè‡ªå®šä¹‰åè®®çš„å•ä¸€ API
* **æä¾›ç¨‹åºæŠ½è±¡**ï¼š40+ èº«ä»½æä¾›ç¨‹åºçš„ä¸€è‡´æ¥å£
* **æ„å»ºå™¨æ¨¡å¼**ï¼šæµç•…çš„ API ç”¨äºé…ç½®èº«ä»½éªŒè¯æµç¨‹
* **ç±»å‹å®‰å…¨**ï¼šå¼ºç±»å‹é…ç½®å’Œå“åº”å¯¹è±¡

### ğŸ” å®‰å…¨ä¼˜å…ˆ

| åŠŸèƒ½ | æè¿° |
| :--- | :--- |
| **PKCE æ”¯æŒ** | ç¬¦åˆ RFC 7636 çš„ä»£ç äº¤æ¢è¯æ˜å¯†é’¥ï¼Œç”¨äºç§»åŠ¨/SPA åº”ç”¨ |
| **çŠ¶æ€éªŒè¯**ï¼šå†…ç½® CSRF ä¿æŠ¤ï¼Œå¸¦çŠ¶æ€å‚æ•°éªŒè¯ |
| **ä»¤ç‰Œç®¡ç†**ï¼šå®‰å…¨ä»¤ç‰Œå­˜å‚¨ã€åˆ·æ–°å’Œæ’¤é”€ |
| **ç­¾åéªŒè¯**ï¼šOAuth1.0a çš„ HMAC-SHA256 ç­¾åæ”¯æŒ |
| **ç¼“å­˜é›†æˆ**ï¼šåˆ†å¸ƒå¼çŠ¶æ€ç¼“å­˜æ”¯æŒ |

### ğŸŒ å¹³å°è¦†ç›–

**ç¤¾äº¤å¹³å°**ï¼ˆ15+ï¼‰
- GitHubã€Googleã€Facebookã€Twitterã€LinkedInã€Microsoft
- å¾®ä¿¡ã€QQã€å¾®åšã€æŠ–éŸ³ã€TikTok
- Appleã€Amazonã€Slackã€Lineã€VK

**ä¼ä¸šå¹³å°**ï¼ˆ10+ï¼‰
- é’‰é’‰ã€é£ä¹¦ã€Larkã€ä¼ä¸šå¾®ä¿¡
- Oktaã€GitLabã€Giteeã€Teambition
- åä¸ºã€é˜¿é‡Œäº‘ã€ç™¾åº¦äº‘

**ç”µå•†å¹³å°**ï¼ˆ8+ï¼‰
- æ”¯ä»˜å®ã€æ·˜å®ã€äº¬ä¸œã€ç¾å›¢ã€é¥¿äº†ä¹ˆ
- é…·å®¶ä¹ã€å°ç±³ã€å°çº¢ä¹¦

**å›½å†…å¹³å°**ï¼ˆä¸­å›½ï¼‰
- å–œé©¬æ‹‰é›…ã€äººäººã€å¼€æºä¸­å›½ã€Codingã€Programmer
- Stack Overflowã€Pinterestã€Figma

### âš¡ å¼€å‘ä½“éªŒ

* **é›¶æ ·æ¿ä»£ç **ï¼šæœ€å°‘ä»£ç å®ç°èº«ä»½éªŒè¯
* **è‡ªåŠ¨é…ç½®**ï¼šçº¦å®šä¼˜äºé…ç½®ï¼Œå…·æœ‰åˆç†çš„é»˜è®¤å€¼
* **çµæ´»ä½œç”¨åŸŸ**ï¼šé€šè¿‡ OAuth ä½œç”¨åŸŸè¿›è¡Œç»†ç²’åº¦æƒé™æ§åˆ¶
* **ä¸°å¯Œçš„å…ƒæ•°æ®**ï¼šæ¥è‡ªæä¾›ç¨‹åºçš„ç»¼åˆç”¨æˆ·é…ç½®æ–‡ä»¶æ•°æ®
* **å¯æ‰©å±•**ï¼šæ˜“äºæ·»åŠ è‡ªå®šä¹‰æä¾›ç¨‹åºæˆ–æ‰©å±•ç°æœ‰æä¾›ç¨‹åº

-----

## ğŸš€ å¿«é€Ÿå¼€å§‹

### Maven ä¾èµ–

```xml
<dependency>
    <groupId>org.miaixz</groupId>
    <artifactId>bus-auth</artifactId>
    <version>8.x.x</version>
</dependency>
```

### åŸºç¡€ç”¨æ³•

#### 1. é…ç½®èº«ä»½éªŒè¯ä¸Šä¸‹æ–‡

```java
// åˆ›å»ºèº«ä»½éªŒè¯ä¸Šä¸‹æ–‡
Context context = Context.builder()
    .clientId("your_client_id")
    .clientSecret("your_client_secret")
    .redirectUri("https://yourapp.com/callback")
    .scopes(Arrays.asList("user", "repo"))
    .build();
```

#### 2. åˆ›å»ºèº«ä»½éªŒè¯æä¾›ç¨‹åº

```java
// æ–¹æ³• 1ï¼šç›´æ¥å®ä¾‹åŒ–
Provider github = new GithubProvider(context);

// æ–¹æ³• 2ï¼šä½¿ç”¨ Authorizer æ„å»ºå™¨ï¼ˆæ¨èï¼‰
Provider github = Authorizer.builder()
    .source("GITHUB")
    .context(context)
    .build();
```

#### 3. ç”Ÿæˆæˆæƒ URL

```java
// ä¸º CSRF ä¿æŠ¤ç”ŸæˆçŠ¶æ€å‚æ•°
String state = UUID.randomUUID().toString();

// è·å–æˆæƒ URL
Message message = github.build(state);
String authUrl = message.getData();

// é‡å®šå‘ç”¨æˆ·åˆ° authUrl
// èº«ä»½éªŒè¯åï¼Œç”¨æˆ·å°†ä½¿ç”¨ code å’Œ state é‡å®šå‘åˆ° redirectUri
```

#### 4. å¤„ç†å›è°ƒå’Œç™»å½•

```java
// æå–å›è°ƒå‚æ•°
Callback callback = Callback.builder()
    .code(request.getParameter("code"))
    .state(request.getParameter("state"))
    .build();

// æ‰§è¡Œèº«ä»½éªŒè¯
Message result = github.authorize(callback);

if (result.isSuccess()) {
    Claims claims = result.getData(Claims.class);
    String uuid = claims.getUuid();
    String username = claims.getUsername();
    String email = claims.getEmail();

    // ç™»å½•ç”¨æˆ·æˆ–åˆ›å»ºè´¦æˆ·
    // å­˜å‚¨ claims.getToken() ç”¨äºæœªæ¥çš„ API è°ƒç”¨
}
```

-----

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. GitHub OAuth2 èº«ä»½éªŒè¯

```java
// é…ç½®
Context context = Context.builder()
    .clientId("github_client_id")
    .clientSecret("github_client_secret")
    .redirectUri("http://localhost:8080/auth/github/callback")
    .build();

Provider github = new GithubProvider(context);

// æ­¥éª¤ 1ï¼šé‡å®šå‘åˆ° GitHub
@GetMapping("/auth/github")
public void githubLogin(HttpServletResponse response) throws IOException {
    String state = UUID.randomUUID().toString();
    cache.set(state, "true", 10, TimeUnit.MINUTES); // åœ¨ç¼“å­˜ä¸­å­˜å‚¨çŠ¶æ€

    Message message = github.build(state);
    response.sendRedirect(message.getData());
}

// æ­¥éª¤ 2ï¼šå¤„ç†å›è°ƒ
@GetMapping("/auth/github/callback")
public Message githubCallback(@RequestParam String code, @RequestParam String state) {
    Callback callback = Callback.builder()
        .code(code)
        .state(state)
        .build();

    Message result = github.authorize(callback);

    if (result.isSuccess()) {
        Claims user = result.getData(Claims.class);
        // å¤„ç†ç”¨æˆ·ä¿¡æ¯
        return Message.success(user);
    }
    return Message.error("èº«ä»½éªŒè¯å¤±è´¥");
}
```

### 2. ä¼ä¸šå¾®ä¿¡èº«ä»½éªŒè¯

```java
// ä¼ä¸šå¾®ä¿¡éœ€è¦é¢å¤–çš„ agentId
Context context = Context.builder()
    .clientId("corp_id")
    .clientSecret("corp_secret")
    .unionId("agent_id")
    .redirectUri("https://yourapp.com/callback/wechat")
    .build();

Provider wechatWork = new WeChatEeWebProvider(context);

// èº«ä»½éªŒè¯æµç¨‹ä¸ GitHub ç›¸åŒ
Message result = wechatWork.authorize(callback);
Claims user = result.getData(Claims.class);
```

### 3. ç§»åŠ¨/SPA åº”ç”¨çš„ PKCE æ¨¡å¼

```java
// å¯ç”¨ PKCE æ¨¡å¼
Context context = Context.builder()
    .clientId("client_id")
    .clientSecret("")  // å…¬å…±å®¢æˆ·ç«¯æ— å®¢æˆ·ç«¯å¯†é’¥
    .redirectUri("myapp://callback")
    .pkce(true)  // å¯ç”¨ PKCE
    .build();

Provider google = new GoogleProvider(context);

// ç”Ÿæˆä»£ç éªŒè¯å™¨å’ŒæŒ‘æˆ˜
String codeVerifier = Builder.codeVerifier();
String codeChallenge = Builder.codeChallenge("S256", codeVerifier);

// å­˜å‚¨ codeVerifier ä¾›ç¨åä½¿ç”¨
cache.set(state, codeVerifier, 10, TimeUnit.MINUTES);

// åœ¨æˆæƒ URL ä¸­åŒ…å« code_challenge
```

### 4. è‡ªå®šä¹‰ OAuth2 æä¾›ç¨‹åº

```java
// æ–¹æ³• 1ï¼šæ‰©å±• AbstractProvider
public class CustomProvider extends AbstractProvider {

    public CustomProvider(Context context) {
        super(context, Complex.custom("CUSTOM", Protocol.OIDC));
    }

    @Override
    public Map<Endpoint, String> getEndpoint() {
        Map<Endpoint, String> endpoints = new HashMap<>();
        endpoints.put(Endpoint.AUTHORIZE, "https://api.custom.com/oauth/authorize");
        endpoints.put(Endpoint.TOKEN, "https://api.custom.com/oauth/token");
        endpoints.put(Endpoint.USERINFO, "https://api.custom.com/oauth/userinfo");
        return endpoints;
    }

    @Override
    public Message token(Callback callback) {
        // è‡ªå®šä¹‰ä»¤ç‰Œäº¤æ¢é€»è¾‘
    }

    @Override
    public Message userInfo(Authorization authorization) {
        // è‡ªå®šä¹‰ç”¨æˆ·ä¿¡æ¯æ£€ç´¢
    }
}

// æ–¹æ³• 2ï¼šä½¿ç”¨ Registry å’Œè‡ªå®šä¹‰ Complex
Complex customComplex = new Complex() {
    @Override
    public String getName() { return "CUSTOM"; }

    @Override
    public Protocol getProtocol() { return Protocol.OIDC; }

    @Override
    public Class<? extends AbstractProvider> getTargetClass() {
        return CustomProvider.class;
    }

    @Override
    public Map<Endpoint, String> endpoint() {
        // è¿”å›ç«¯ç‚¹æ˜ å°„
    }
};

Provider provider = Authorizer.builder()
    .source("CUSTOM")
    .context(context)
    .complex(customComplex)
    .build();
```

### 5. ä»¤ç‰Œç®¡ç†

```java
// è·å–è®¿é—®ä»¤ç‰Œ
Message tokenMsg = provider.token(callback);
Authorization token = tokenMsg.getData(Authorization.class);

// è®¿é—®ä»¤ç‰Œè¯¦æƒ…
String accessToken = token.getToken();
int expiresIn = token.getExpireIn();
String refreshToken = token.getRefresh();

// åˆ·æ–°ä»¤ç‰Œï¼ˆå¦‚æœæ”¯æŒï¼‰
Message refreshMsg = provider.refresh(token);
Authorization newToken = refreshMsg.getData(Authorization.class);

// æ’¤é”€æˆæƒï¼ˆç™»å‡ºï¼‰
Message revokeMsg = provider.revoke(token);
```

### 6. å¤šæä¾›ç¨‹åºæ”¯æŒ

```java
// æä¾›ç¨‹åºæ³¨å†Œè¡¨
Map<String, Provider> providers = new HashMap<>();

// é…ç½®å¤šä¸ªæä¾›ç¨‹åº
providers.put("github", new GithubProvider(githubContext));
providers.put("google", new GoogleProvider(googleContext));
providers.put("wechat", new WeChatMpProvider(wechatContext));

// ç»Ÿä¸€èº«ä»½éªŒè¯ç«¯ç‚¹
@PostMapping("/auth/{provider}")
public Message authenticate(@PathVariable String provider,
                            @RequestBody Callback callback) {
    Provider authProvider = providers.get(provider);
    if (authProvider == null) {
        return Message.error("ä¸æ”¯æŒçš„æä¾›ç¨‹åºï¼š" + provider);
    }

    return authProvider.authorize(callback);
}
```

### 7. è‡ªå®šä¹‰ç¼“å­˜å®ç°

```java
// ä½¿ç”¨ Redis è¿›è¡Œåˆ†å¸ƒå¼çŠ¶æ€ç¼“å­˜
public class RedisAuthCache implements CacheX {

    private final RedisTemplate<String, String> redisTemplate;

    @Override
    public void set(String key, Object value, long timeout, TimeUnit unit) {
        redisTemplate.opsForValue().set(key, value.toString(), timeout, unit);
    }

    @Override
    public String get(String key) {
        return redisTemplate.opsForValue().get(key);
    }

    @Override
    public boolean containsKey(String key) {
        return Boolean.TRUE.equals(redisTemplate.hasKey(key));
    }

    @Override
    public void remove(String key) {
        redisTemplate.delete(key);
    }
}

// ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜
RedisAuthCache cache = new RedisAuthCache(redisTemplate);
Provider github = new GithubProvider(context, cache);
```

### 8. åŠ¨æ€ç«¯ç‚¹é…ç½®

```java
// è¦†ç›–é»˜è®¤ç«¯ç‚¹
Map<Endpoint, String> customEndpoints = new HashMap<>();
customEndpoints.put(Endpoint.AUTHORIZE, "https://custom.auth.com/authorize");
customEndpoints.put(Endpoint.TOKEN, "https://custom.auth.com/token");
customEndpoints.put(Endpoint.USERINFO, "https://custom.auth.com/userinfo");
customEndpoints.put(Endpoint.REFRESH, "https://custom.auth.com/refresh");

Context context = Context.builder()
    .clientId("client_id")
    .clientSecret("client_secret")
    .redirectUri("https://yourapp.com/callback")
    .endpoint(customEndpoints)  // è‡ªå®šä¹‰ç«¯ç‚¹
    .build();
```

-----

## ğŸ“‹ é…ç½®å‚è€ƒ

### ä¸Šä¸‹æ–‡å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…éœ€ | æè¿° |
| :--- | :--- | :--- | :--- |
| `clientId` | String | âœ… | OAuth2 å®¢æˆ·ç«¯ ID æˆ– API å¯†é’¥ |
| `clientSecret` | String | âœ… | OAuth2 å®¢æˆ·ç«¯å¯†é’¥ |
| `unionId` | String | âŒ | å¹³å°ç‰¹å®šæ ‡è¯†ç¬¦ï¼ˆä¾‹å¦‚ï¼Œå¾®ä¿¡ agentIdï¼‰ |
| `extId` | String | âŒ | æ‰©å±•æ ‡è¯†ç¬¦ |
| `deviceId` | String | âŒ | æŸäº›å¹³å°çš„è®¾å¤‡ ID |
| `type` | String | âŒ | å¹³å°ç‰¹å®šç±»å‹ |
| `flag` | boolean | âŒ | å¹³å°ç‰¹å®šæ ‡å¿— |
| `pkce` | boolean | âŒ | å¯ç”¨ PKCE æ¨¡å¼ï¼ˆé»˜è®¤ï¼šfalseï¼‰ |
| `prefix` | String | âŒ | åŸŸå‰ç¼€ï¼ˆç”¨äº Oktaã€Codingï¼‰ |
| `redirectUri` | String | âœ… | OAuth2 å›è°ƒ URL |
| `scopes` | List<String> | âŒ | OAuth2 ä½œç”¨åŸŸï¼ˆæƒé™ï¼‰ |
| `ignoreState` | boolean | âŒ | è·³è¿‡çŠ¶æ€éªŒè¯ï¼ˆä¸æ¨èï¼‰ |
| `ignoreRedirectUri` | boolean | âŒ | è·³è¿‡é‡å®šå‘ URI éªŒè¯ |
| `kid` | String | âŒ | Apple å¯†é’¥ ID |
| `teamId` | String | âŒ | Apple å›¢é˜Ÿ ID |
| `loginType` | String | âŒ | ä¼ä¸šå¾®ä¿¡ç™»å½•ç±»å‹ |
| `lang` | String | âŒ | è¯­è¨€ä»£ç ï¼ˆé»˜è®¤ï¼šzhï¼‰ |
| `extension` | String | âŒ | æ‰©å±•å±æ€§ |
| `endpoint` | Map<Endpoint, String> | âŒ | è‡ªå®šä¹‰ OAuth ç«¯ç‚¹ |

### æ”¯æŒçš„ç«¯ç‚¹

| ç«¯ç‚¹ | æè¿° |
| :--- | :--- |
| `AUTHORIZE` | æˆæƒç«¯ç‚¹ URL |
| `TOKEN` | ä»¤ç‰Œç«¯ç‚¹ URL |
| `USERINFO` | ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹ URL |
| `REFRESH` | ä»¤ç‰Œåˆ·æ–°ç«¯ç‚¹ URL |
| `REVOKE` | ä»¤ç‰Œæ’¤é”€ç«¯ç‚¹ URL |

### æä¾›ç¨‹åºæ³¨å†Œè¡¨

æ‰€æœ‰å†…ç½®æä¾›ç¨‹åºéƒ½åœ¨ `Registry` æšä¸¾ä¸­æ³¨å†Œï¼š

```java
// è®¿é—®æ³¨å†Œè¡¨
Registry.GITHUB
Registry.GOOGLE
Registry.WECHAT_MP
Registry.DINGTALK
// ... 40+ æä¾›ç¨‹åº

// ä¸ Authorizer ä¸€èµ·ä½¿ç”¨
Provider provider = Authorizer.builder()
    .source(Registry.GITHUB.getName())
    .context(context)
    .build();
```

-----

## ğŸ”§ é«˜çº§é…ç½®

### 1. è‡ªå®šä¹‰ä½œç”¨åŸŸé…ç½®

```java
// æ¯ä¸ªæä¾›ç¨‹åºæä¾›é»˜è®¤ä½œç”¨åŸŸ
// å¯ä»¥ä¸ºç‰¹å®šéœ€æ±‚è‡ªå®šä¹‰ä½œç”¨åŸŸ

Context context = Context.builder()
    .clientId("client_id")
    .clientSecret("client_secret")
    .redirectUri("https://yourapp.com/callback")
    .scopes(Arrays.asList("read", "write", "email"))  // è‡ªå®šä¹‰ä½œç”¨åŸŸ
    .build();
```

### 2. çŠ¶æ€éªŒè¯

```java
// é»˜è®¤å¯ç”¨çŠ¶æ€éªŒè¯
// ç¦ç”¨ï¼ˆç”Ÿäº§ç¯å¢ƒä¸æ¨èï¼‰ï¼š

Context context = Context.builder()
    .clientId("client_id")
    .clientSecret("client_secret")
    .redirectUri("https://yourapp.com/callback")
    .ignoreState(true)  // âš ï¸ ç¦ç”¨çŠ¶æ€éªŒè¯
    .build();
```

### 3. è‡ªå®šä¹‰ç”¨æˆ·ä¿¡æ¯æ˜ å°„

```java
// æ‰©å±• AbstractProvider ä»¥è‡ªå®šä¹‰ç”¨æˆ·ä¿¡æ¯è§£æ

public class CustomGithubProvider extends GithubProvider {

    @Override
    public Message userInfo(Authorization authorization) {
        // è·å–åŸå§‹ç”¨æˆ·æ•°æ®
        Message response = super.userInfo(authorization);

        // è‡ªå®šä¹‰æ˜ å°„é€»è¾‘
        Map<String, Object> rawData = response.getData();
        Claims claims = Claims.builder()
            .uuid(rawData.get("id").toString())
            .username(rawData.get("login").toString())
            .email(rawData.get("email").toString())
            .avatar(rawData.get("avatar_url").toString())
            .source("GITHUB")
            .token(authorization)
            .rawJson(JsonKit.toJsonString(rawData))
            .build();

        return Message.success(claims);
    }
}
```

### 4. é”™è¯¯å¤„ç†

```java
try {
    Message result = provider.authorize(callback);

    if (result.isSuccess()) {
        Claims user = result.getData(Claims.class);
        // æˆåŠŸå¤„ç†
    } else {
        // é”™è¯¯å¤„ç†
        String errorCode = result.getErrcode();
        String errorMsg = result.getErrmsg();
    }
} catch (AuthorizedException e) {
    // å¤„ç†èº«ä»½éªŒè¯å¼‚å¸¸
    log.error("èº«ä»½éªŒè¯å¤±è´¥", e);

    // å¸¸è§é”™è¯¯ä»£ç ï¼š
    // 110001 - ä¸æ”¯æŒçš„æä¾›ç¨‹åºæˆ–é…ç½®æ— æ•ˆ
    // 110002 - é…ç½®ä¸å®Œæ•´
    // 110005 - æ— æ•ˆçš„é‡å®šå‘ URI
    // 110007 - ç¼ºå°‘æˆæƒä»£ç 
    // 110008 - çŠ¶æ€æ— æ•ˆæˆ–å·²è¿‡æœŸ
}
```

-----

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å§‹ç»ˆä½¿ç”¨ HTTPS

```java
// âŒ ä¸æ¨è
Context context = Context.builder()
    .redirectUri("http://yourapp.com/callback")
    .build();

// âœ… æ¨è
Context context = Context.builder()
    .redirectUri("https://yourapp.com/callback")
    .build();
```

### 2. å¯ç”¨çŠ¶æ€éªŒè¯

```java
// âœ… å§‹ç»ˆåœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨çŠ¶æ€éªŒè¯
Context context = Context.builder()
    .ignoreState(false)  // é»˜è®¤ï¼šfalse
    .build();
```

### 3. ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜

```java
// âœ… ä½¿ç”¨ Redis æˆ–å…¶ä»–åˆ†å¸ƒå¼ç¼“å­˜å­˜å‚¨çŠ¶æ€
RedisAuthCache cache = new RedisAuthCache(redisTemplate);
Provider provider = new GithubProvider(context, cache);
```

### 4. å®ç°é€‚å½“çš„é”™è¯¯å¤„ç†

```java
// âœ… å…¨é¢çš„é”™è¯¯å¤„ç†
try {
    Message result = provider.authorize(callback);
    // å¤„ç†ç»“æœ
} catch (AuthorizedException e) {
    // è®°å½•é”™è¯¯è¯¦æƒ…
    log.error("èº«ä»½éªŒè¯å¤±è´¥ï¼šcode={}, message={}",
        e.getCode(), e.getMessage());

    // è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
    return Message.error("ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•");
}
```

### 5. éªŒè¯é‡å®šå‘ URI

```java
// âœ… å§‹ç»ˆéªŒè¯é‡å®šå‘ URI ä¸é…ç½®åŒ¹é…
String redirectUri = request.getParameter("redirect_uri");
if (!context.getRedirectUri().equals(redirectUri)) {
    throw new SecurityException("æ— æ•ˆçš„é‡å®šå‘ URI");
}
```

### 6. å®‰å…¨å­˜å‚¨ä»¤ç‰Œ

```java
// âœ… åœ¨å­˜å‚¨åˆ°æ•°æ®åº“ä¹‹å‰åŠ å¯†ä»¤ç‰Œ
String encryptedToken = crypto.encrypt(claims.getToken().getToken());

User user = new User();
user.setAccessToken(encryptedToken);
user.setRefreshToken(crypto.encrypt(claims.getToken().getRefresh()));
user.setTokenExpiry(LocalDateTime.now().plusSeconds(claims.getToken().getExpireIn()));
```

### 7. å®ç°ä»¤ç‰Œåˆ·æ–°

```java
// âœ… è‡ªåŠ¨åˆ·æ–°è¿‡æœŸä»¤ç‰Œ
if (user.isTokenExpired()) {
    Message refreshMsg = provider.refresh(claims.getToken());
    Authorization newToken = refreshMsg.getData(Authorization.class);

    // æ›´æ–°å­˜å‚¨çš„ä»¤ç‰Œ
    user.setAccessToken(crypto.encrypt(newToken.getToken()));
    user.setTokenExpiry(LocalDateTime.now().plusSeconds(newToken.getExpireIn()));
}
```

### 8. å¤„ç†é€Ÿç‡é™åˆ¶

```java
// âœ… ä¸ºèº«ä»½éªŒè¯ç«¯ç‚¹å®ç°é€Ÿç‡é™åˆ¶
@RateLimit(requests = 10, period = 1, timeUnit = TimeUnit.MINUTES)
@PostMapping("/auth/github")
public Message authenticate(@RequestBody Callback callback) {
    return githubProvider.authorize(callback);
}
```

-----

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰ OAuth æä¾›ç¨‹åºï¼Ÿ

```java
// æ–¹æ³• 1ï¼šæ‰©å±• AbstractProvider
public class MyProvider extends AbstractProvider {
    public MyProvider(Context context) {
        super(context, new Complex() {
            @Override public String getName() { return "MYPROVIDER"; }
            @Override public Protocol getProtocol() { return Protocol.OIDC; }
            @Override public Class<? extends AbstractProvider> getTargetClass() {
                return MyProvider.class;
            }
            @Override public Map<Endpoint, String> endpoint() {
                // è¿”å›ç«¯ç‚¹æ˜ å°„
            }
        });
    }

    @Override
    public Message token(Callback callback) { /* å®ç° */ }

    @Override
    public Message userInfo(Authorization authorization) { /* å®ç° */ }
}
```

### Q2: å¦‚ä½•ä¸ºç§»åŠ¨åº”ç”¨å¤„ç† PKCEï¼Ÿ

```java
// å®¢æˆ·ç«¯ï¼ˆç§»åŠ¨åº”ç”¨ï¼‰ï¼š
String codeVerifier = Builder.codeVerifier();
String codeChallenge = Builder.codeChallenge("S256", codeVerifier);

// åœ¨æˆæƒ URL ä¸­åŒ…å« code_challenge

// æœåŠ¡å™¨ç«¯ï¼š
// ä»å›è°ƒä¸­æå– code_verifier å¹¶ä½¿ç”¨å®ƒäº¤æ¢ä»¤ç‰Œ
```

### Q3: å¦‚ä½•ä¸º Spring Boot åº”ç”¨å®ç°"ä½¿ç”¨ GitHub ç™»å½•"ï¼Ÿ

```java
@Controller
public class AuthController {

    @Autowired
    private Provider githubProvider;

    @GetMapping("/login/github")
    public String loginGithub(HttpSession session) {
        String state = UUID.randomUUID().toString();
        session.setAttribute("oauth_state", state);

        Message message = githubProvider.build(state);
        return "redirect:" + message.getData();
    }

    @GetMapping("/auth/github/callback")
    public String callback(@RequestParam String code,
                          @RequestParam String state,
                          HttpSession session) {
        // éªŒè¯çŠ¶æ€
        String savedState = (String) session.getAttribute("oauth_state");
        if (!state.equals(savedState)) {
            throw new SecurityException("æ— æ•ˆçŠ¶æ€");
        }

        // èº«ä»½éªŒè¯
        Callback callback = Callback.builder()
            .code(code)
            .state(state)
            .build();

        Message result = githubProvider.authorize(callback);
        Claims user = result.getData(Claims.class);

        // åˆ›å»ºç”¨æˆ·ä¼šè¯
        session.setAttribute("user", user);

        return "redirect:/dashboard";
    }
}
```

### Q4: å¦‚ä½•è°ƒè¯•èº«ä»½éªŒè¯é—®é¢˜ï¼Ÿ

```java
// å¯ç”¨è°ƒè¯•æ—¥å¿—
logging.level.org.miaixz.bus.auth=DEBUG

// æ£€æŸ¥é…ç½®
Checker.check(context, Registry.GITHUB);

// éªŒè¯å›è°ƒ
Checker.check(Registry.GITHUB, callback);

// è®°å½•ä»¤ç‰Œå“åº”
Message tokenMsg = provider.token(callback);
log.debug("ä»¤ç‰Œå“åº”ï¼š{}", tokenMsg);
```

### Q5: å¦‚ä½•æ”¯æŒå¤šä¸ªé‡å®šå‘ URIï¼Ÿ

```java
// æ ¹æ®è¯·æ±‚åŠ¨æ€ä¸Šä¸‹æ–‡
Context getContextForRequest(HttpServletRequest request) {
    String redirectUri = determineRedirectUri(request);

    return Context.builder()
        .clientId(clientId)
        .clientSecret(clientSecret)
        .redirectUri(redirectUri)
        .build();
}
```

### Q6: å¦‚ä½•å®ç°å•ç‚¹ç™»å‡ºï¼Ÿ

```java
@PostMapping("/logout")
public Message logout(HttpSession session) {
    Claims user = (Claims) session.getAttribute("user");

    // æ’¤é”€ä»¤ç‰Œ
    provider.revoke(user.getToken());

    // æ¸…é™¤ä¼šè¯
    session.invalidate();

    return Message.success("ç™»å‡ºæˆåŠŸ");
}
```

### Q7: å¦‚ä½•å¤„ç†ä»¤ç‰Œè¿‡æœŸï¼Ÿ

```java
// åœ¨ API è°ƒç”¨å‰æ£€æŸ¥ä»¤ç‰Œè¿‡æœŸ
public void callApi(Claims user) {
    Authorization token = user.getToken();

    if (isTokenExpired(token)) {
        // åˆ·æ–°ä»¤ç‰Œ
        Message refreshMsg = provider.refresh(token);
        Authorization newToken = refreshMsg.getData(Authorization.class);
        user.setToken(newToken);
    }

    // ä½¿ç”¨æ–°ä»¤ç‰Œ
    callApiWithToken(newToken.getToken());
}
```

### Q8: æ”¯æŒå“ªäº›æä¾›ç¨‹åºï¼Ÿ

Bus Auth æ”¯æŒ **40+** æä¾›ç¨‹åºï¼ŒåŒ…æ‹¬ï¼š
- ç¤¾äº¤ï¼šGitHubã€Googleã€Facebookã€Twitterã€LinkedInã€Microsoftã€Apple
- ä¸­å›½ï¼šå¾®ä¿¡ã€QQã€å¾®åšã€æŠ–éŸ³ã€é’‰é’‰ã€é£ä¹¦
- ä¼ä¸šï¼šOktaã€GitLabã€Giteeã€ä¼ä¸šå¾®ä¿¡
- æ›´å¤šï¼æŸ¥çœ‹ `Registry` æšä¸¾è·å–å®Œæ•´åˆ—è¡¨ã€‚

-----

## ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§

| Bus Auth ç‰ˆæœ¬ | JDK ç‰ˆæœ¬ | Spring Boot | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| 8.x | 17+ | 3.x | å½“å‰ç¨³å®šç‰ˆæœ¬ |
| 7.x | 11+ | 2.x | æ—§ç‰ˆæœ¬ |

-----

## ğŸš€ è·¯çº¿å›¾

- [ ] å…¶ä»– OAuth2 æä¾›ç¨‹åº
- [ ] OpenID Connect å‘ç°æ”¯æŒ
- [ ] JWT ä»¤ç‰ŒéªŒè¯å·¥å…·
- [ ] å¢å¼ºçš„ä»¤ç‰Œç¼“å­˜ç­–ç•¥
- [ ] å¤šç§Ÿæˆ·èº«ä»½éªŒè¯æ”¯æŒ
- [ ] èº«ä»½éªŒè¯äº‹ä»¶é’©å­
- [ ] å…¨é¢çš„æµ‹è¯•è¦†ç›–

-----

## ğŸ“Š æ”¯æŒçš„æä¾›ç¨‹åº

### ç¤¾äº¤ç™»å½•
- GitHubã€GitLabã€Gitee
- Googleã€Facebookã€Twitterã€LinkedInã€Microsoft
- Appleã€Amazonã€Slackã€Lineã€VK
- Stack Overflowã€Pinterestã€Figma

### ä¸­å›½å¹³å°
- å¾®ä¿¡ï¼ˆå…¬ä¼—å·ã€å¼€æ”¾å¹³å°ã€å°ç¨‹åºã€ä¼ä¸šï¼‰
- QQã€å¾®åšã€æŠ–éŸ³ã€ä»Šæ—¥å¤´æ¡
- é’‰é’‰ã€é£ä¹¦ã€ç™¾åº¦ã€å°ç±³
- æ”¯ä»˜å®ã€æ·˜å®ã€äº¬ä¸œã€ç¾å›¢

### ä¼ä¸š
- Oktaã€GitLabã€Coding
- ä¼ä¸šå¾®ä¿¡
- é˜¿é‡Œäº‘ã€åä¸ºäº‘

### å›½å†…ï¼ˆä¸­å›½ï¼‰
- å–œé©¬æ‹‰é›…ã€äººäººã€å¼€æºä¸­å›½
- é…·å®¶ä¹ã€ç¨‹åºå‘˜å®¢æ ˆã€å°çº¢ä¹¦
- Teambitionã€é¥¿äº†ä¹ˆ

å®Œæ•´åˆ—è¡¨è¯·å‚è§ `Registry` æšä¸¾ã€‚

-----

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·éšæ—¶æäº¤æ‹‰å–è¯·æ±‚ã€‚

-----

## ğŸ“„ è®¸å¯è¯

[MIT License (MIT)](https://github.com/818000/bus/blob/main/LICENSE)

ç‰ˆæƒæ‰€æœ‰ (c) 2015-2026 miaixz.org åŠå…¶ä»–è´¡çŒ®è€…ã€‚

-----

## ğŸ”— é“¾æ¥

- [GitHub ä»“åº“](https://github.com/818000/bus)
- [é—®é¢˜è¿½è¸ª](https://github.com/818000/bus/issues)
- [Maven Central](https://central.sonatype.com/artifact/org.miaixz/bus-auth)
